<!DOCTYPE html>
<html>
<head>
    <title>Debug Spicy Contributions Extension</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { background: #24292f; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üêõ Debug Spicy Contributions Extension</h1>
    
    <div class="test-section info">
        <h3>üìã Extension Status Check</h3>
        <p>This page will help you debug why the extension isn't showing red squares.</p>
        <button onclick="checkExtensionStatus()">Check Extension Status</button>
        <div id="extension-status"></div>
    </div>

    <div class="test-section info">
        <h3>üîç Test GitHub API Access</h3>
        <p>Test if your GitHub token can access the repository data.</p>
        <input type="password" id="debug-token" placeholder="Enter your GitHub token" style="width: 300px; margin: 10px 0;" />
        <br>
        <button onclick="testGitHubAPI()">Test GitHub API</button>
        <div id="api-test-result"></div>
    </div>

    <div class="test-section info">
        <h3>üìÖ Test Repository Detection</h3>
        <p>Test if the extension can detect the current repository.</p>
        <button onclick="testRepoDetection()">Test Repository Detection</button>
        <div id="repo-test-result"></div>
    </div>

    <div class="test-section info">
        <h3>üéØ Manual Test</h3>
        <p>Create a test issue and close it to see if the extension picks it up.</p>
        <button onclick="createAndCloseTestIssue()">Create & Close Test Issue</button>
        <div id="manual-test-result"></div>
    </div>

    <script>
        async function checkExtensionStatus() {
            const statusDiv = document.getElementById('extension-status');
            statusDiv.innerHTML = '<p>Checking extension status...</p>';
            
            try {
                // Check if extension is available
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await new Promise((resolve) => {
                        chrome.runtime.sendMessage({ type: "FETCH_DATES", currentRepo: "netn10/Spicy-Contributions" }, resolve);
                    });
                    
                    if (response && response.ok) {
                        statusDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Extension is working!</h4>
                                <p>Found ${response.bugDates.length} bug days and ${response.failDates.length} failure days.</p>
                                <pre>Bug dates: ${JSON.stringify(response.bugDates, null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå Extension error:</h4>
                                <p>${response?.error || 'Unknown error'}</p>
                            </div>
                        `;
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Extension not detected</h4>
                            <p>Make sure the Spicy Contributions extension is installed and enabled.</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error checking extension:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testGitHubAPI() {
            const token = document.getElementById('debug-token').value.trim();
            const resultDiv = document.getElementById('api-test-result');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">Please enter a GitHub token</div>';
                return;
            }

            resultDiv.innerHTML = '<p>Testing GitHub API...</p>';

            try {
                // Test basic API access
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Accept': 'application/vnd.github+json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // Test repository access
                    const repoResponse = await fetch('https://api.github.com/repos/netn10/Spicy-Contributions', {
                        headers: {
                            'Accept': 'application/vnd.github+json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (repoResponse.ok) {
                        const repo = await repoResponse.json();
                        resultDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ GitHub API access working!</h4>
                                <p>Authenticated as: ${user.login}</p>
                                <p>Repository access: ${repo.full_name}</p>
                                <p>Repository visibility: ${repo.private ? 'Private' : 'Public'}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå Repository access failed</h4>
                                <p>Status: ${repoResponse.status}</p>
                                <p>Make sure your token has the 'repo' scope for private repositories.</p>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå GitHub API authentication failed</h4>
                            <p>Status: ${response.status}</p>
                            <p>Check if your token is valid and not expired.</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå API test failed:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function testRepoDetection() {
            const resultDiv = document.getElementById('repo-test-result');
            
            // Simulate the extension's repository detection logic
            const pathParts = window.location.pathname.split('/').filter(Boolean);
            const detectedRepo = pathParts.length >= 2 ? `${pathParts[0]}/${pathParts[1]}` : null;
            
            // Also check for meta tag
            const repoElement = document.querySelector('meta[name="octolytics-dimension-repository_nwo"]');
            const metaRepo = repoElement ? repoElement.getAttribute('content') : null;
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>üîç Repository Detection Results</h4>
                    <p><strong>Current URL:</strong> ${window.location.href}</p>
                    <p><strong>Path-based detection:</strong> ${detectedRepo || 'Not detected'}</p>
                    <p><strong>Meta tag detection:</strong> ${metaRepo || 'Not found'}</p>
                    <p><strong>Final result:</strong> ${detectedRepo || metaRepo || 'No repository detected'}</p>
                </div>
            `;
        }

        async function createAndCloseTestIssue() {
            const token = document.getElementById('debug-token').value.trim();
            const resultDiv = document.getElementById('manual-test-result');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">Please enter a GitHub token first</div>';
                return;
            }

            resultDiv.innerHTML = '<p>Creating test issue...</p>';

            try {
                // Create issue
                const createResponse = await fetch('https://api.github.com/repos/netn10/Spicy-Contributions/issues', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github+json',
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'Debug Test Issue',
                        body: 'This is a test issue for debugging the Spicy Contributions extension.',
                        labels: ['bug']
                    })
                });

                if (createResponse.ok) {
                    const issue = await createResponse.json();
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Test issue created!</h4>
                            <p><a href="${issue.html_url}" target="_blank">Issue #${issue.number}</a></p>
                            <p>Now closing the issue...</p>
                        </div>
                    `;

                    // Close the issue
                    const closeResponse = await fetch(`https://api.github.com/repos/netn10/Spicy-Contributions/issues/${issue.number}`, {
                        method: 'PATCH',
                        headers: {
                            'Accept': 'application/vnd.github+json',
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            state: 'closed'
                        })
                    });

                    if (closeResponse.ok) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Test issue created and closed!</h4>
                                <p><a href="${issue.html_url}" target="_blank">Issue #${issue.number}</a> has been closed.</p>
                                <p><strong>Next steps:</strong></p>
                                <ol>
                                    <li>Refresh your GitHub profile page</li>
                                    <li>Check if today's contribution square turns red</li>
                                    <li>If not, check the browser console for errors</li>
                                </ol>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå Failed to close issue</h4>
                                <p>Issue was created but couldn't be closed automatically.</p>
                                <p><a href="${issue.html_url}" target="_blank">Please close it manually</a></p>
                            </div>
                        `;
                    }
                } else {
                    const error = await createResponse.json();
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Failed to create issue</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Manual test failed:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
